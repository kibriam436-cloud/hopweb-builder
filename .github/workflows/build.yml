name: Build Android APK
on:
  repository_dispatch:
    types: [build_app]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Cordova
        run: npm install -g cordova

      - name: Create and Inject Code
        env:
          HTML_DATA: ${{ github.event.client_payload.html_code }}
          APP_NAME: ${{ github.event.client_payload.app_name }}
        run: |
          FINAL_NAME="${APP_NAME:-MyApp}"
          cordova create myapp com.hopweb.app "$FINAL_NAME"
          printf "%s" "$HTML_DATA" > myapp/www/index.html
          
          # ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶≠‡¶ø‡¶â ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
          cat > myapp/config.xml <<EOF
          <?xml version='1.0' encoding='utf-8'?>
          <widget id="com.hopweb.app" version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
              <name>$FINAL_NAME</name>
              <description>App built with HopWeb Studio</description>
              <author email="admin@example.com">HopWeb User</author>
              <content src="index.html" />
              <access origin="*" />
              <allow-intent href="http://*/*" />
              <allow-intent href="https://*/*" />
              <preference name="Fullscreen" value="true" />
              <preference name="Orientation" value="default" />
              <preference name="AndroidWindowSplashScreenAnimatedIcon" value="res/icon.png" />
          </widget>
          EOF

      - name: Add Android Platform
        working-directory: ./myapp
        run: |
          cordova platform add android@11.0.0
          cordova plugin add cordova-plugin-inappbrowser
          cordova plugin add cordova-plugin-whitelist
          cordova plugin add cordova-plugin-splashscreen

      - name: Build APK
        working-directory: ./myapp
        run: |
          cordova build android --release -- --packageType=apk

      - name: Upload APK to Firebase
        id: upload
        run: |
          APK_FILE=$(find myapp/platforms/android -name "*.apk" | head -n 1)
          echo "üì± APK ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá: $APK_FILE"
          
          # Firebase Storage ‡¶è ‡¶Ü‡¶™‡¶≤‡ßã‡¶° (‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡¶∞‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø)
          BUILD_ID="${{ github.event.client_payload.build_id }}"
          DATABASE_URL="https://e-commerce-90208-default-rtdb.firebaseio.com"
          
          # ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase Storage Bucket
          BUCKET="e-commerce-90208.firebasestorage.app"
          
          # APK ‡¶´‡¶æ‡¶á‡¶≤‡¶ï‡ßá Base64 ‡¶è ‡¶è‡¶®‡¶ï‡ßã‡¶° ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
          if command -v base64 &> /dev/null; then
            # ‡¶õ‡ßã‡¶ü ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶≤‡ßá base64
            APK_BASE64=$(base64 -w0 "$APK_FILE")
            
            # Firebase Realtime Database ‡¶è ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
            curl -X PUT -d "{\"apk_base64\": \"$APK_BASE64\", \"status\": \"ready\"}" "$DATABASE_URL/builds/$BUILD_ID/apk.json"
            
            DOWNLOAD_URL="https://$DATABASE_URL/builds/$BUILD_ID/apk.json"
          else
            # ‡¶¨‡¶°‡¶º ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø GitHub Artifact
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

      - name: Notify Firebase
        env:
          DOWNLOAD_URL: ${{ steps.upload.outputs.download_url }}
        run: |
          BUILD_ID="${{ github.event.client_payload.build_id }}"
          DATABASE_URL="https://e-commerce-90208-default-rtdb.firebaseio.com"
          
          curl -X PATCH -d "{
            \"download_url\": \"$DOWNLOAD_URL\",
            \"status\": \"finished\",
            \"message\": \"‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ APK ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§! ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®\"
          }" "$DATABASE_URL/builds/$BUILD_ID.json"

      - name: Upload Artifact (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: myapp/platforms/android/app/build/outputs/apk/release/*.apk
          retention-days: 7
